<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Notas</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 16px }
        input { display:block; margin:8px 0; padding:8px; width:100% }
        #saveNote { padding:8px 12px }
        #notesContainer > div { border:10px solid #ddd; padding:8px; margin:8px 0 }

        .modal {
            display: none;
            position: fixed;
            inset: 0; 
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
        }

        .deleteButton {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Minhas Notas</h1>
    <input type="text" id="noteTitle" placeholder="Título da nota">
    <input type="text" id="noteContent" placeholder="Conteúdo da nota">
    <button id="saveNote">Salvar Nota</button>
    <div id="notesContainer"></div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2>Editar nota</h2>
            
            <input type="text" id="newTitle" placeholder="Novo título">
            <input type="text" id="newContent" placeholder="Novo conteúdo">

            <div class="buttons">
                <button onclick="closeModal()">Cancelar</button>
                <button onclick="submitData()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        let selectedId;
        let selectedDiv;
        const apiUrl = 'http://localhost:3000';

        const saveNoteButton = document.getElementById('saveNote');
        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const notesContainer = document.getElementById('notesContainer');

        // Carrega notas do servidor
        fetch(`${apiUrl}/notes`)
            .then(response => response.json())
            .then(data => {
                data.forEach(note => {
                    const created = note.creationDate ? new Date(note.creationDate).toLocaleString() : '';
                    createNoteDiv(note.id, note.title, note.content, created);
                });
        })
        .catch(err => console.error('Erro ao carregar notas:', err));

        saveNoteButton.addEventListener('click', () => {
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();

            if (!title || !content) {
                alert('Por favor, preencha ambos os campos para salvar a nota.');
                return;
            }

            fetch(`${apiUrl}/note`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            })
            .then(response => {
                if (!response.ok) throw new Error('Falha ao salvar nota');
                return response.json();
            })
            .then(savedNote => {
                const created = savedNote.creationDate ? new Date(savedNote.creationDate).toLocaleString() : new Date().toLocaleString();
                createNoteDiv(savedNote.id, savedNote.title, savedNote.content, created);
                noteTitleInput.value = '';
                noteContentInput.value = '';
            })
            .catch(err => {
                console.error(err);
                alert('Não foi possível salvar a nota.');
            });
        });

        function createNoteDiv(id, title, content, creationDate) {
            const noteElement = document.createElement('div');
            noteElement.innerHTML = `
                <h3>${escapeHtml(title)}</h3>
                <p>${escapeHtml(content)}</p>
                <small>${escapeHtml(creationDate)}</small>
            `;

            const deleteButton = document.createElement('button');
            deleteButton.classList.add("deleteButton")
            deleteButton.textContent = "Excluir"
            
            const editButton = document.createElement('button');
            editButton.textContent = "Editar"

            deleteButton.addEventListener('click', () => {
                fetch(`${apiUrl}/note/${id}`, {
                    method:"DELETE",
                })
                .then(response => {
                    if (!response.ok) throw new Error('Falha ao deletar nota');

                    noteElement.remove()
                })
            })

            editButton.addEventListener('click', () => {
                openModal()
                selectedId = id
                selectedDiv = noteElement
            })

            noteElement.appendChild(deleteButton);
            noteElement.appendChild(editButton);
            notesContainer.appendChild(noteElement);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function openModal() {
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function submitData() {
            const newTitle = document.getElementById('newTitle');
            const newContent = document.getElementById('newContent');

            fetch(`${apiUrl}/note/${selectedId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle.value, content: newContent.value })
            })
            .then(response => {
                if (!response.ok) throw new Error('Falha ao editar nota');
                
                selectedDiv.querySelector("h3").textContent = newTitle.value
                selectedDiv.querySelector("p").textContent = newContent.value
                
                newTitle.value = '';
                newContent.value = '';
            })
            .catch(err => {
                console.error(err);
                alert('Não foi possível editar a nota.');
            });

            closeModal();
        }
    </script>
</body>
</html>